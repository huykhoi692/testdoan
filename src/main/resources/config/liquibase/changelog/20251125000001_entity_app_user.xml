<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- ========================================= -->
    <!-- 1. CREATE APP_USER TABLE                 -->
    <!-- ========================================= -->

    <changeSet id="20251125000001-1" author="system">
        <comment>Create app_user table for extended user profile</comment>

        <createTable tableName="app_user">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="display_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="bio" type="${clobType}">
                <constraints nullable="true"/>
            </column>
            <column name="timezone" type="varchar(50)">
                <constraints nullable="true"/>
            </column>
            <column name="internal_user_id" type="bigint">
                <constraints nullable="true" unique="true" uniqueConstraintName="ux_app_user_internal_user_id"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="20251125000001-2" author="system">
        <comment>Add foreign key to jhi_user</comment>

        <addForeignKeyConstraint
            baseColumnNames="internal_user_id"
            baseTableName="app_user"
            constraintName="fk_app_user_internal_user_id"
            referencedColumnNames="id"
            referencedTableName="jhi_user"/>
    </changeSet>

    <!-- ========================================= -->
    <!-- 2. ENHANCE USER.IMAGE_URL                -->
    <!-- ========================================= -->

    <changeSet id="20251125000001-3" author="system">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="jhi_user" columnName="image_url"/>
        </preConditions>

        <comment>Modify User.image_url to support base64 data URIs (LONGTEXT/CLOB)</comment>

        <!-- MySQL/MariaDB -->
        <modifyDataType
            tableName="jhi_user"
            columnName="image_url"
            newDataType="LONGTEXT"
            dbms="mysql,mariadb"/>

        <!-- PostgreSQL -->
        <modifyDataType
            tableName="jhi_user"
            columnName="image_url"
            newDataType="TEXT"
            dbms="postgresql"/>

        <!-- Oracle -->
        <modifyDataType
            tableName="jhi_user"
            columnName="image_url"
            newDataType="CLOB"
            dbms="oracle"/>

        <!-- H2 (for testing) -->
        <modifyDataType
            tableName="jhi_user"
            columnName="image_url"
            newDataType="CLOB"
            dbms="h2"/>

        <!-- SQL Server -->
        <modifyDataType
            tableName="jhi_user"
            columnName="image_url"
            newDataType="NVARCHAR(MAX)"
            dbms="mssql"/>
    </changeSet>

</databaseChangeLog>

