<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
        Add fields to Achievement and UserAchievement for Rich Domain Model.

        Achievement:
        - criteria_type: Type of achievement (STREAK, EXERCISES, CHAPTERS, etc.)
        - target_value: Value needed to unlock
        - icon_url: Icon for the achievement

        UserAchievement:
        - progress: Current progress value
        - is_unlocked: Whether achievement is unlocked
        - unlocked_at: When it was unlocked
    -->

    <!-- ========================================= -->
    <!-- ACHIEVEMENT TABLE                         -->
    <!-- ========================================= -->

    <changeSet id="20251210000003-1" author="rich-domain-model">
        <preConditions onFail="MARK_RAN">
            <not><columnExists tableName="achievement" columnName="criteria_type"/></not>
        </preConditions>
        <addColumn tableName="achievement">
            <column name="criteria_type" type="varchar(50)">
                <constraints nullable="true"/>
            </column>
            <column name="target_value" type="bigint">
                <constraints nullable="true"/>
            </column>
            <column name="icon_url" type="varchar(500)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <comment>Add fields for achievement criteria and rules</comment>
    </changeSet>

    <!-- ========================================= -->
    <!-- USER_ACHIEVEMENT TABLE                    -->
    <!-- ========================================= -->

    <changeSet id="20251210000003-2" author="rich-domain-model">
        <preConditions onFail="MARK_RAN">
            <not><columnExists tableName="user_achievement" columnName="progress"/></not>
        </preConditions>
        <addColumn tableName="user_achievement">
            <column name="progress" type="double">
                <constraints nullable="true"/>
            </column>
            <column name="is_unlocked" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="unlocked_at" type="timestamp">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <comment>Add progress tracking fields for Rich Domain Model</comment>
    </changeSet>

    <!-- ========================================= -->
    <!-- INDEXES                                   -->
    <!-- ========================================= -->

    <changeSet id="20251210000003-3" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_achievement_criteria_type" tableName="achievement"/></not>
        </preConditions>
        <createIndex indexName="idx_achievement_criteria_type" tableName="achievement">
            <column name="criteria_type"/>
        </createIndex>
        <comment>Index for achievement criteria lookup</comment>
    </changeSet>

    <changeSet id="20251210000003-4" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_user_achievement_unlocked" tableName="user_achievement"/></not>
        </preConditions>
        <createIndex indexName="idx_user_achievement_unlocked" tableName="user_achievement">
            <column name="app_user_id"/>
            <column name="is_unlocked"/>
        </createIndex>
        <comment>Index for finding unlocked achievements by user</comment>
    </changeSet>

</databaseChangeLog>

