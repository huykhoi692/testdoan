<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
        Additional performance indexes for cross-table queries.

        NOTE: Entity-specific indexes are in their respective entity files.
        This file contains indexes for:
        - user_vocabulary (SRS system)
        - learning_streak
        - book (filtering)
        - chapter (ordering)
    -->

    <!-- ========================================= -->
    <!-- USER VOCABULARY INDEXES (SRS SYSTEM)      -->
    <!-- ========================================= -->

    <changeSet id="20251210000002-7" author="performance">
        <preConditions onFail="HALT">
            <not><indexExists indexName="idx_user_vocab_review_date" tableName="user_vocabulary"/></not>
        </preConditions>
        <createIndex indexName="idx_user_vocab_review_date" tableName="user_vocabulary">
            <column name="app_user_id"/>
            <column name="next_review_date"/>
            <column name="is_memorized"/>
        </createIndex>
        <comment>Performance: For SRS queries (findByNextReviewDateLessThanEqual)</comment>
    </changeSet>

    <!-- ========================================= -->
    <!-- LEARNING STREAK INDEXES                   -->
    <!-- ========================================= -->

    <changeSet id="20251210000002-8" author="performance">
        <preConditions onFail="HALT">
            <not><indexExists indexName="idx_learning_streak_user" tableName="learning_streak"/></not>
        </preConditions>
        <createIndex indexName="idx_learning_streak_user" tableName="learning_streak">
            <column name="app_user_id"/>
            <column name="last_study_date"/>
        </createIndex>
        <comment>Performance: For streak calculation and validation</comment>
    </changeSet>

    <!-- ========================================= -->
    <!-- BOOK & CHAPTER INDEXES                    -->
    <!-- ========================================= -->

    <changeSet id="20251210000002-10" author="performance">
        <preConditions onFail="HALT">
            <not><indexExists indexName="idx_book_active_level" tableName="book"/></not>
        </preConditions>
        <createIndex indexName="idx_book_active_level" tableName="book">
            <column name="is_active"/>
            <column name="level"/>
        </createIndex>
        <comment>Performance: For filtering books by active status and level</comment>
    </changeSet>

    <changeSet id="20251210000002-11" author="performance">
        <preConditions onFail="HALT">
            <not><indexExists indexName="idx_chapter_book_order" tableName="chapter"/></not>
        </preConditions>
        <createIndex indexName="idx_chapter_book_order" tableName="chapter">
            <column name="book_id"/>
            <column name="order_index"/>
        </createIndex>
        <comment>Performance: For fetching chapters in order</comment>
    </changeSet>

</databaseChangeLog>

