<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="20251231_refactor_skills_1" author="jhipster">
        <!-- Create ReadingPassage -->
        <createTable tableName="reading_passage">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="content" type="${clobType}">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="chapter_id" type="bigint">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="chapter_id"
                                 baseTableName="reading_passage"
                                 constraintName="fk_reading_passage_chapter"
                                 referencedColumnNames="id"
                                 referencedTableName="chapter"/>

        <!-- Create ListeningAudio -->
        <createTable tableName="listening_audio">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="audio_url" type="varchar(512)">
                <constraints nullable="false"/>
            </column>
            <column name="transcript" type="${clobType}">
                <constraints nullable="true"/>
            </column>
            <column name="chapter_id" type="bigint">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="chapter_id"
                                 baseTableName="listening_audio"
                                 constraintName="fk_listening_audio_chapter"
                                 referencedColumnNames="id"
                                 referencedTableName="chapter"/>

        <!-- Create SpeakingTopic -->
        <createTable tableName="speaking_topic">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="context" type="${clobType}">
                <constraints nullable="true"/>
            </column>
            <column name="image_url" type="varchar(512)">
                <constraints nullable="true"/>
            </column>
            <column name="chapter_id" type="bigint">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="chapter_id"
                                 baseTableName="speaking_topic"
                                 constraintName="fk_speaking_topic_chapter"
                                 referencedColumnNames="id"
                                 referencedTableName="chapter"/>

        <!-- Create WritingTask -->
        <createTable tableName="writing_task">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="prompt" type="${clobType}">
                <constraints nullable="false"/>
            </column>
            <column name="image_url" type="varchar(512)">
                <constraints nullable="true"/>
            </column>
            <column name="chapter_id" type="bigint">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="chapter_id"
                                 baseTableName="writing_task"
                                 constraintName="fk_writing_task_chapter"
                                 referencedColumnNames="id"
                                 referencedTableName="chapter"/>
    </changeSet>

    <changeSet id="20251231_refactor_skills_2" author="jhipster">
        <!-- Update ReadingExercise -->
        <addColumn tableName="reading_exercise">
            <column name="reading_passage_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="reading_passage_id"
                                 baseTableName="reading_exercise"
                                 constraintName="fk_reading_exercise_passage"
                                 referencedColumnNames="id"
                                 referencedTableName="reading_passage"/>
        <dropColumn tableName="reading_exercise" columnName="passage"/>
        <dropForeignKeyConstraint baseTableName="reading_exercise" constraintName="fk_reading_exercise_chapter"/>
        <dropColumn tableName="reading_exercise" columnName="chapter_id"/>

        <!-- Update ListeningExercise -->
        <addColumn tableName="listening_exercise">
            <column name="listening_audio_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="listening_audio_id"
                                 baseTableName="listening_exercise"
                                 constraintName="fk_listening_exercise_audio"
                                 referencedColumnNames="id"
                                 referencedTableName="listening_audio"/>
        <dropColumn tableName="listening_exercise" columnName="audio_path"/>
        <dropColumn tableName="listening_exercise" columnName="transcript"/>
        <dropForeignKeyConstraint baseTableName="listening_exercise" constraintName="fk_listening_exercise_chapter"/>
        <dropColumn tableName="listening_exercise" columnName="chapter_id"/>

        <!-- Update SpeakingExercise -->
        <addColumn tableName="speaking_exercise">
            <column name="speaking_topic_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="speaking_topic_id"
                                 baseTableName="speaking_exercise"
                                 constraintName="fk_speaking_exercise_topic"
                                 referencedColumnNames="id"
                                 referencedTableName="speaking_topic"/>
        <dropColumn tableName="speaking_exercise" columnName="prompt"/>
        <dropForeignKeyConstraint baseTableName="speaking_exercise" constraintName="fk_speaking_exercise_chapter"/>
        <dropColumn tableName="speaking_exercise" columnName="chapter_id"/>

        <!-- Update WritingExercise -->
        <addColumn tableName="writing_exercise">
            <column name="writing_task_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="writing_task_id"
                                 baseTableName="writing_exercise"
                                 constraintName="fk_writing_exercise_task"
                                 referencedColumnNames="id"
                                 referencedTableName="writing_task"/>
        <dropColumn tableName="writing_exercise" columnName="prompt"/>
        <dropForeignKeyConstraint baseTableName="writing_exercise" constraintName="fk_writing_exercise_chapter"/>
        <dropColumn tableName="writing_exercise" columnName="chapter_id"/>
    </changeSet>

</databaseChangeLog>

