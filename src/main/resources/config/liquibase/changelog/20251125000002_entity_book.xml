<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- ========================================= -->
    <!-- 1. CREATE BOOK TABLE                     -->
    <!-- ========================================= -->

    <changeSet id="20251125000002-1" author="system">
        <comment>Create book table with soft delete and rating statistics</comment>

        <createTable tableName="book">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="title" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="level" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(5000)">
                <constraints nullable="true"/>
            </column>
            <column name="thumbnail" type="varchar(500)">
                <constraints nullable="true"/>
            </column>
            <!-- Soft delete support -->
            <column name="is_active" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <!-- Rating statistics (denormalized for performance) -->
            <column name="average_rating" type="double" defaultValueNumeric="0.0">
                <constraints nullable="true"/>
            </column>
            <column name="total_reviews" type="bigint" defaultValueNumeric="0">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ========================================= -->
    <!-- 2. INDEXES FOR PERFORMANCE               -->
    <!-- ========================================= -->

    <changeSet id="20251125000002-2" author="system">
        <comment>Create indexes for frequently queried columns</comment>

        <createIndex indexName="idx_book_level" tableName="book">
            <column name="level"/>
        </createIndex>

        <createIndex indexName="idx_book_is_active" tableName="book">
            <column name="is_active"/>
        </createIndex>

        <createIndex indexName="idx_book_title" tableName="book">
            <column name="title"/>
        </createIndex>

        <createIndex indexName="idx_book_average_rating" tableName="book">
            <column name="average_rating"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>

