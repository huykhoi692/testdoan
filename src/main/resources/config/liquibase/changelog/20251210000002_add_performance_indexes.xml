<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
        Add performance indexes to prevent Full Table Scan.

        CRITICAL INDEXES:
        1. StudySession: start_at, end_at (for date range queries)
        2. ChapterProgress: chapter_id, app_user_id, completed (for performance analytics)
        3. ExerciseResult: submitted_at (for archival queries)
        4. UserVocabulary: app_user_id, next_review_date (for SRS system)

        WHY:
        - Native SQL queries in BusinessAnalyticsService scan millions of rows
        - Without indexes = Full Table Scan = Database hang when data grows
        - With indexes = Index Scan = Fast even with 10M+ rows
    -->

    <!-- ========================================= -->
    <!-- STUDY SESSION INDEXES                     -->
    <!-- ========================================= -->

    <!-- Composite index for date range queries in analytics -->
    <changeSet id="20251210000002-1" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_study_session_date_range" tableName="study_session"/></not>
        </preConditions>
        <createIndex indexName="idx_study_session_date_range" tableName="study_session">
            <column name="start_at"/>
            <column name="end_at"/>
        </createIndex>
        <comment>Performance: For DAU/WAU/MAU queries and session duration calculations</comment>
    </changeSet>

    <!-- Index for user-specific queries -->
    <changeSet id="20251210000002-2" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_study_session_user_date" tableName="study_session"/></not>
        </preConditions>
        <createIndex indexName="idx_study_session_user_date" tableName="study_session">
            <column name="app_user_id"/>
            <column name="start_at"/>
        </createIndex>
        <comment>Performance: For user study history and streak calculations</comment>
    </changeSet>

    <!-- ========================================= -->
    <!-- CHAPTER PROGRESS INDEXES                  -->
    <!-- ========================================= -->

    <!-- Composite index for chapter performance analytics -->
    <changeSet id="20251210000002-3" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_chapter_progress_analytics" tableName="chapter_progress"/></not>
        </preConditions>
        <createIndex indexName="idx_chapter_progress_analytics" tableName="chapter_progress">
            <column name="chapter_id"/>
            <column name="completed"/>
            <column name="app_user_id"/>
        </createIndex>
        <comment>Performance: For chapter completion rate and drop-off analysis</comment>
    </changeSet>

    <!-- Index for user progress queries -->
    <changeSet id="20251210000002-4" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_chapter_progress_user" tableName="chapter_progress"/></not>
        </preConditions>
        <createIndex indexName="idx_chapter_progress_user" tableName="chapter_progress">
            <column name="app_user_id"/>
            <column name="last_accessed"/>
        </createIndex>
        <comment>Performance: For user progress tracking and recent activity</comment>
    </changeSet>

    <!-- ========================================= -->
    <!-- EXERCISE RESULT INDEXES                   -->
    <!-- ========================================= -->

    <!-- Index for archival queries (DataArchivingService) -->
    <changeSet id="20251210000002-5" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_exercise_result_submitted_at" tableName="exercise_result"/></not>
        </preConditions>
        <createIndex indexName="idx_exercise_result_submitted_at" tableName="exercise_result">
            <column name="submitted_at"/>
        </createIndex>
        <comment>Performance: For data archiving queries (countBySubmittedAtBefore)</comment>
    </changeSet>

    <!-- Composite index for user exercise history -->
    <changeSet id="20251210000002-6" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_exercise_result_user_type" tableName="exercise_result"/></not>
        </preConditions>
        <createIndex indexName="idx_exercise_result_user_type" tableName="exercise_result">
            <column name="app_user_id"/>
            <column name="exercise_type"/>
            <column name="submitted_at"/>
        </createIndex>
        <comment>Performance: For user exercise statistics and history</comment>
    </changeSet>

    <!-- ========================================= -->
    <!-- USER VOCABULARY INDEXES (SRS SYSTEM)      -->
    <!-- ========================================= -->

    <!-- Index for Spaced Repetition System (SRS) -->
    <changeSet id="20251210000002-7" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_user_vocab_review_date" tableName="user_vocabulary"/></not>
        </preConditions>
        <createIndex indexName="idx_user_vocab_review_date" tableName="user_vocabulary">
            <column name="app_user_id"/>
            <column name="next_review_date"/>
            <column name="is_memorized"/>
        </createIndex>
        <comment>Performance: For SRS queries (findByNextReviewDateLessThanEqual)</comment>
    </changeSet>

    <!-- ========================================= -->
    <!-- LEARNING STREAK INDEXES                   -->
    <!-- ========================================= -->

    <!-- Index for streak lookups by user -->
    <changeSet id="20251210000002-8" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_learning_streak_user" tableName="learning_streak"/></not>
        </preConditions>
        <createIndex indexName="idx_learning_streak_user" tableName="learning_streak">
            <column name="app_user_id"/>
            <column name="last_study_date"/>
        </createIndex>
        <comment>Performance: For streak calculation and validation</comment>
    </changeSet>

    <!-- ========================================= -->
    <!-- NOTIFICATION INDEXES                      -->
    <!-- ========================================= -->

    <!-- Index for unread notifications query -->
    <!-- NOTE: This index already exists in 20251125000027, so we skip it -->
    <!-- The original table already has idx_notification_user_read -->

    <!-- ========================================= -->
    <!-- BOOK & CHAPTER INDEXES                    -->
    <!-- ========================================= -->

    <!-- Index for active books query -->
    <changeSet id="20251210000002-10" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_book_active_level" tableName="book"/></not>
        </preConditions>
        <createIndex indexName="idx_book_active_level" tableName="book">
            <column name="is_active"/>
            <column name="level"/>
        </createIndex>
        <comment>Performance: For filtering books by active status and level</comment>
    </changeSet>

    <!-- Index for chapter ordering -->
    <changeSet id="20251210000002-11" author="performance">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_chapter_book_order" tableName="chapter"/></not>
        </preConditions>
        <createIndex indexName="idx_chapter_book_order" tableName="chapter">
            <column name="book_id"/>
            <column name="order_index"/>
        </createIndex>
        <comment>Performance: For fetching chapters in order</comment>
    </changeSet>

</databaseChangeLog>

